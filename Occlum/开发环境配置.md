# Occlum 开发环境配置

## 一、docker 环境搭建

采用 **docker** + **wsl2** + **vscode** 搭建开发环境（无 SGX 硬件支持）

**1. 下载镜像**

docker 镜像地址：[链接](https://hub.docker.com/r/occlum/occlum/tags)

```shell
docker pull occlum/occlum:latest-ubuntu20.04
```

**2. 创建容器**

```shell
// 查看镜像
docker images

// 创建并运行容器
docker run -it occlum/occlum:latest-ubuntu20.04 /bin/bash
```

![image-20241002173611482](https://raw.githubusercontent.com/charming-c/image-host/master/img/image-20241002173611482.png)

**3. 在 vscode 附加到容器中**

在 docker 插件中找到运行的容器，打开

> 问题：关于容器启动就立即 exit 的原因
>
> 直接在 desktop 运行容器，这时启动的容器是临时的，由于没有持续运行的进程，容器在运行完毕之后就自动退出了，可以使用 -it，采用容器的交互模式，打开容器的 `/bin/bash` 进行交互。参数 -t 让 Docker 分配一个伪终端并绑定在容器的标准输入上，-i 让容器的标准输入保持打开。
>
> 使用docker run命令来启动容器，docker在后台运行的标准操作包括
>
> 1. 检查本地是否存在指定的镜像，不存在则从公有仓库下载
> 2. 使用镜像创建并启动容器
> 3. 分配一个文件系统，并在只读的镜像层外面挂载一层可读可写层
> 4. 从宿主主机配置的网桥接口中桥接一个虚拟接口道容器中去
> 5. 从地址池分配一个ip地址给容器
> 6. 执行用户指定的应用程序
> 7. 执行完毕之后容器被终止

## 二、Occlum 源码编译

指南：[参考链接](https://occlum.readthedocs.io/en/latest/build_and_install.html#build-from-source)

**1. 下载 Occlum 源码**

```shell
mkdir occlum && cd occlum
git clone https://github.com/occlum/occlum .
```

**2. Occlum 前置工具**

```shell
make submodule
```

> 推荐使用 latest 镜像，在使用 0.31.0-rc-ubuntu20.04 等镜像时出现报错：
>
> ```c
> /usr/bin/ld: cannot find -lsgx_urts_sim_with_se_event: No such file or directory
> collect2: error: ld returned 1 exit status
> make[2]: *** [Makefile:192: /home/rongan/zheng/occlum/build/bin/occlum-protect-integrity] Error 1
> ```
>
> 修改到 latest 镜像才成功

![image-20241002174450366](https://raw.githubusercontent.com/charming-c/image-host/master/img/image-20241002174450366.png)

**3. 编译并测试**

```shell
SGX_MODE=SIM make

# test musl based binary
SGX_MODE=SIM make test

# test glibc based binary
SGX_MODE=SIM make test-glibc

# stress test
SGX_MODE=SIM make test times=100
```

**4. 安装 Occlum**

```shell
make install
```

<img src="https://raw.githubusercontent.com/charming-c/image-host/master/img/image-20241002213015637.png" alt="image-20241002213015637"  />

