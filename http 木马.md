# HTTP/HTTPS 木马通信

## 一、 HTTP 协议

1. 超文本传输协议

    - HTTP 是面向事务的应用层协议
    - 使用 TCP 连接进行可靠传送
    - 定义了客户端和服务器间通信的格式和规则
    - 在网络之间可靠的交换文件

2. HTTP 的报文结构

    1. 两类报文

    - 请求报文：从客户端向服务器的请求
    - 响应报文：从服务器到客户的回答

    2. 三个组成部分

    - 开始行：用于区分是请求报文还是响应报文
    - 首部行：说明浏览器、服务器或报文主体的信息，可以多行，可以不使用
    - 实体主体：报文主体部分

    3. 报文结构：（请求和响应）

3. HTTP 的缺点

    - 通信使用明文（不加密），内容可能会被窃听
    - 不验证通信方的身份，因此有可能遭遇伪装
    - 无法证明报文完整性，所以有可能已遭篡改

    这些问题不仅在 HTTP 中出现，其他未加密的协议中也会存在类似的问题。

## 二、 HTTPS 协议

1. HTTPS = HTTP + SSL
    - HTTPS 不是新的应用层协议，只是 HTTP 通信接口部分用 SSL 和 TLS 协议代替而已。
    - 通常 HTTP 直接和 TCP 通信，当使用 SSL 时，则演变成先和 SSL 通信，再由 SSL 和 TCP 通信。
    - SSL 是独立于 HTTP 的协议，所以不光是 HTTP 协议，其他运行在应用层的 SMTP 和 Telnet等协议均可配合 SSL 协议使用。可以说 SSL 是世界上应用最为广泛的网络安全技术。
2. HTTPS 的 HTTP 视图
3. HTTPS 通信机制
4. SSL 和 TSL
    - HTTPS 使用 SSL 和 TLS 两个协议。
    - SSL 的前两个版本被发现有问题，主流版本是 SSL3.0。
    - TLS 适宜 SSL3.0 为原型开发，当前主流是 TLS1.0，TLS 有时也称为 SSL。
    - SSL 需要加密和解密步骤，所以通信慢，且过程中要计算需要消耗 CPU 和 内存等资源。

## 三、 木马案例

### 1. 基于 http 通信的木马

1. DarkComet RAT
    - 描述: DarkComet 是一种流行的远程访问木马（RAT），通过HTTP协议与控制服务器通信，伪装成正常的网络流量。
    - 功能: 提供远程桌面访问、键盘记录、文件管理等功能。攻击者可以通过HTTP发送命令并接收受感染计算机上的数据。
    - 传播途径: 通过钓鱼邮件、恶意附件或社交工程攻击传播。
2. NjRAT
    - 描述: NjRAT 是一种广泛使用的RAT，主要利用HTTP通信与攻击者的控制服务器联系。
    - 功能: 具有文件窃取、键盘记录、屏幕监控等功能，还可以下载和执行远程文件。
    - 传播途径: 通常通过钓鱼链接、恶意网站或社交工程传播。

### 2. 基于 https 通信的木马

1. Emotet
    - 描述: Emotet是一种高度复杂的木马，最初是银行木马，后来演变为一个模块化的恶意软件平台，利用HTTPS协议进行命令与控制（C2）通信。
    - 功能: Emotet不仅能窃取银行凭据，还可以下载其他恶意软件。它使用HTTPS加密通信以增加隐蔽性。
    - 传播途径: 主要通过钓鱼邮件和恶意附件传播。
2. Dridex
    - 描述: Dridex 是一种专门针对金融机构的木马，利用HTTPS加密与其控制服务器通信，确保数据传输的安全性和隐蔽性。
    - 功能: 它窃取银行登录信息，记录键盘输入，并通过HTTPS将这些信息发送给攻击者。Dridex 还支持模块化加载，可以执行多种恶意任务。
    - 传播途径: 主要通过恶意宏的电子邮件传播，诱导用户启用并运行恶意代码。

## 四、 优缺点

1. 优点

    1. **隐蔽性强**:

        - **常规流量**: HTTP和HTTPS是网络上最常用的协议，木马可以伪装成正常的网页请求或响应，难以被网络防火墙和入侵检测系统（IDS）识别。
        - **绕过防火墙**: 因为HTTP和HTTPS流量通常被信任，很多防火墙和网络安全设备不会深度检查这些流量，给木马通信提供了掩护。

        **广泛的跨平台兼容性**:

        - **通用协议**: HTTP/HTTPS是通用的网络协议，可以在几乎所有操作系统和设备上使用。这使得木马能够在多种环境中有效运行和通信。

        **使用加密提升隐蔽性（HTTPS）**:

        - **加密通信**: 通过HTTPS协议，木马通信可以被加密，保护数据在传输过程中不被拦截或篡改，这使得监控和分析恶意流量变得更加困难。

        **可靠的传输**:

        - **稳定性**: HTTP和HTTPS都提供了可靠的通信渠道，适合需要稳定数据传输的木马。

2. 缺点

    1. **明文传输（HTTP）**:
        - **易被分析**: 使用HTTP的木马通信是明文的，虽然隐蔽性强，但如果流量被拦截或抓包，很容易被解码和分析。
    2. **加密流量可能引起怀疑（HTTPS）**:
        - **异常流量检测**: 尽管HTTPS流量是加密的，但异常的大量HTTPS流量或流量模式可能引起安全监控系统的怀疑，尤其是在无名证书或不可信证书的情况下。
    3. **依赖外部网络**:
        - **网络限制**: HTTP/HTTPS木马需要依赖目标主机访问外部网络。如果目标网络实施了严格的网络访问控制，可能会限制木马的通信能力。
    4. **证书管理复杂性（HTTPS）**:
        - **SSL/TLS证书**: 使用HTTPS的木马可能需要管理或伪造SSL/TLS证书，这增加了技术实现的复杂性，也可能增加被检测的风险。
    5. **网络性能影响**:
        - **延迟和开销**: HTTPS的加密和解密过程可能引入额外的网络延迟和计算开销，特别是在通信频繁时，可能影响木马的响应速度。

# p2p 网络通信技术

## 一、p2p 概述

- p2p，英文全称：Peer To Peer，点对点技术
- p2p是一种区别于C/S的网络模型，没有统一的中心服务器结点，各个Client也是提供服务的Server。

## 二、p2p 分类

- 根据中央化程度
    - 一般型P2P
        - 节点同时作为客户端和服务器端
        - 没有中心服务器
        - 没有中心路由器
        - 典型代表：Gnutella，一种文件共享网络，泛滥式查询搜索所有节点
    - 特殊型P2P
        - 一个中心服务器保存节点信息
        - 节点负责发布这些信息，让中心服务器知道它们想共享什么文件
        - 路由终端使用地址，被一组索引引用来获取绝对地址
        - 典型代表：Napster，一种音乐共享网络，依赖中央服务器协调网络中的查询
    - 混合型P2P
        - 同时含有一般型和特殊型的特点
        - 典型代表：Skype
- 根据网络拓扑结构
    - 结构P2P
        - 点对点之间互有链接咨询，彼此形成特定规则拓扑结构
        - 需要请求资源时，依该拓扑结构规则寻找，若存在则一定找得到
        - 典型代表：Chord、YaCy（分布式开源免费网页搜索引擎系统，保护用户隐私，无中央服务器搜索，保证内容不被审查）、Kademlia（一种协议算法，规定网络的结构同时，规定通过节点查询进行信息交换的方式，快速定位期望的节点）
    - 无结构P2P
        - 点对点之间互有链接咨询，彼此形成无规则拓扑结构
        - 需要请求资源时，以广播方式寻找，通常会设TTL，即使存在也不一定找得到
        - 典型代表：Gnutella
    - 松散结构P2P
        - 点对点之间互有链接咨询，彼此形成无规则拓扑结构
        - 需要请求资源时，依现有咨询推测寻找，介于P2P结构和无结构型之间
        - 典型代表：Freenet（一个软件，匿名互联网领域）

## 三、P2P 优缺点

**优点**:

- **去中心化**: 无需中央服务器，降低了单点故障的风险，增强了系统的弹性。
- **扩展性好**: 随着更多节点的加入，网络的处理能力和资源可用性也相应增加。
- **抗审查性强**: 由于没有中央节点，P2P网络难以被封锁或审查。

**缺点**:

- **管理复杂**: 由于节点可以自由加入和离开，维护网络的一致性和安全性较为复杂。
- **安全问题**: 去中心化的特点使得网络更容易受到恶意节点或攻击的影响，如分布式拒绝服务（DDoS）攻击。
- **带宽占用**: 节点需要上传和下载数据，这可能会消耗大量带宽，特别是在文件共享应用中。

## 四、木马案例

### 1. **Storm Worm（Storm Botnet）**

- **描述**: Storm Worm 是一个著名的僵尸网络（botnet），使用P2P网络进行命令与控制。它通过P2P协议将受感染的计算机连接在一起，使得网络中的每个节点都可以传播指令和恶意软件更新。
- **功能**: 这个木马主要用于发送垃圾邮件、发起分布式拒绝服务（DDoS）攻击和分发其他恶意软件。它利用P2P网络的分布式特性，难以追踪并且可以快速传播。
- **传播途径**: 通过恶意电子邮件附件和被感染的网站传播。

### 2. **ZeroAccess**

- **描述**: ZeroAccess 是一个庞大的P2P僵尸网络，用于分发广告点击欺诈和比特币挖矿软件。它通过P2P网络进行指令传递和更新，感染的计算机彼此之间共享数据。
- **功能**: ZeroAccess木马可以利用受感染的计算机进行比特币挖矿，并在用户不知情的情况下执行点击欺诈，从而产生非法收益。
- **传播途径**: 主要通过恶意广告（malvertising）和感染的下载软件传播。

### 3. **TDL-4（Alureon）**

- **描述**: TDL-4 是一个复杂的根木马，利用P2P网络进行命令与控制。它通过P2P网络下载更新和新指令，并能够隐蔽在受感染的系统中，逃避传统的安全软件检测。
- **功能**: TDL-4能够窃取用户数据、下载和安装其他恶意软件，并且可以通过其P2P网络动态更新自身，增强生存能力。
- **传播途径**: 通过感染的合法网站、软件漏洞和恶意下载传播。



## 五、P2P木马的特点和优缺点

- **优点**:
    - **去中心化**: 没有单一的控制服务器，难以追踪和关闭整个僵尸网络。
    - **隐蔽性强**: 通过P2P网络通信使得恶意流量难以与正常流量区分。
    - **自我更新**: 通过P2P网络，木马可以自行传播更新和新指令，提升生存能力。
- **缺点**:
    - **复杂性**: 实现和维护一个P2P通信网络比传统的集中式控制难度更高。
    - **潜在安全漏洞**: P2P网络中的节点互相连接，可能存在被识别或攻击的风险，尤其是如果安全措施不完善。
    - **带宽消耗**: 由于需要传递大量数据，P2P木马可能会消耗受感染计算机的带宽。