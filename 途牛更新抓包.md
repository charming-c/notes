# 途牛更新抓包相关

- 抓包版本：10.74.0
    - 无 SSL pinning
- 更新版本：11.3.0
    - 有 SSL pinning， ？？？应用启动时会直接崩溃

### 1. 检查更新的接口

接口： **https://m.tuniu.com/iapi/appserver/view/checkUpgradeV382?eyJjbGllbnRUeXBlIjoyMCwiY3VycmVudFZlcnNpb24iOiIxMC43NC4wIiwiaGVpZ2h0IjowLCJzcGxhc2hJZCI6MCwid2lkdGgiOjAsInIiOiIxNzAxMTcxNzk5NDczIiwicGFydG5lciI6MTc2MDgsImNsaWVudFR5cGUiOjIwLCJkZXZpY2VUeXBlIjoxLCJ2ZXJzaW9uIjoiMTAuNzQuMCIsIl9jdXJyZW50Q2l0eUNvZGUiOiIyNTAwIn0= HTTP/1.1**

```json
{
    "clientType": 20,
    "currentVersion": "10.74.0",
    "height": 0,
    "splashId": 0,
    "width": 0,
    "r": "1701171799473",
    "partner": 17608,
    "clientType": 20,
    "deviceType": 1,
    "version": "10.74.0",
    "_currentCityCode": "2500"
}
```



请求头:

>Sid: c321ff89-6421-4877-8fbc-d56ec4be360e
>User-Agent: TuNiuApp/10.74.0 (Android)
>Sessionid: d56d6f176d1856598e913cac79859246_
>Showrecommend: 1

响应：

> 响应头：
>
> Set-Cookie: acw_tc=76b20f4817011717998965967ef963101f3638f7a1040f58848ac190bab0d6;path=/;HttpOnly;Max-Age=1800
>
> repsonse（base 64编码）：
>
> eyJzdWNjZXNzIjp0cnVlLCJtc2ciOiJzdWNjZXNzIiwiZXJyb3JDb2RlIjoiNzEwMDAwIiwiZGF0YSI6eyJzaG91bGRTaG93T2xkRElZIjpmYWxzZSwiaXNVcGdyYWRlTmVlZGVkIjp0cnVlLCJpc0ZvcmNlVXBncmFkZSI6ZmFsc2UsImxhdGVzdFZlcnNpb25OdW1iZXIiOiIxMS4zLjAiLCJ1cGdyYWRlUmVhc29uIjpbIlx1NTNkMVx1NzNiMFx1NGUwMFx1NGUyYVx1NjViMFx1NzI0OFx1NjcyY1x1ZmYwY1x1OGJmN1x1NTM0N1x1N2VhN1x1NjcwMFx1NjViMFx1NzI0OFx1NjcyY1x1ZmYwY1x1NGY1M1x1OWE4Y1x1NjZmNFx1NTJhMFx1OTg3YVx1NmVkMVx1ZmYwMSJdLCJ1cGdyYWRlUGF0aCI6Imh0dHA6XC9cL2ltYWdlcy50dW5pdWNkbi5jb21cL2FuZHJvaWRcL3dhcFwvdHVuaXUuYXBrICIsInNwbGFzaCI6eyJzcGxhc2hJZCI6NSwic3RhcnREYXRlIjoiMjAxNS0wOC0zMSAwMDowMDowMCIsImVuZERhdGUiOiIyMDI2LTA4LTMxIDAwOjAwOjAwIiwic3BsYXNoVXJsIjoiaHR0cHM6XC9cL200LnR1bml1Y2RuLmNvbVwvZmIyXC90MVwvRzVcL00wMFwvOERcLzlFXC9DaWktczFxcUFRYUlYQmp6QUFDM3hDMzVVWllBQUVSb0FObXp1Y0FBTGZjMzguanBlZyJ9fX0=

```json
// 请求成功
{
    "success": true,
    "msg": "success",
    "errorCode": "710000",
    "data": {
        "shouldShowOldDIY": false,
        "isUpgradeNeeded": true,
        "isForceUpgrade": false,
        "latestVersionNumber": "11.3.0",
        "upgradeReason": [
            "\u53d1\u73b0\u4e00\u4e2a\u65b0\u7248\u672c\uff0c\u8bf7\u5347\u7ea7\u6700\u65b0\u7248\u672c\uff0c\u4f53\u9a8c\u66f4\u52a0\u987a\u6ed1\uff01"
 // unicode 发现一个新版本，请升级最新版本，体验更加顺滑！
        ],
        "upgradePath": "http:\/\/images.tuniucdn.com\/android\/wap\/tuniu.apk ",
        "splash": {
            "splashId": 5,
            "startDate": "2015-08-31 00:00:00",
            "endDate": "2026-08-31 00:00:00",
            "splashUrl": "https:\/\/m4.tuniucdn.com\/fb2\/t1\/G5\/M00\/8D\/9E\/Cii-s1qqAQaIXBjzAAC3xC35UZYAAERoANmzucAALfc38.jpeg"
        }
    }
}

// 请求失败
{
    "success": false,
    "msg": "Parameter is invalid",
    "errorCode": "710003",
    "data": {
        "shouldShowOldDIY": true,
        "isUpgradeNeeded": false,
        "isForceUpgrade": false,
        "latestVersionNumber": "",
        "upgradeReason": [],
        "upgradePath": "",
        "splash": {}
    }
}
```

### 2. 更新接口

接口：**http://images.tuniucdn.com/android/wap/tuniu.apk**

### 3. 反编译源码解析

百度加固

frida-dexdump 脱壳

#### 1. 关于请求和响应的 bean：

请求：

![image-20231129202531003](https://raw.githubusercontent.com/charming-c/image-host/master/img/image-20231129202531003.png)

![image-20231129202557439](https://raw.githubusercontent.com/charming-c/image-host/master/img/image-20231129202557439.png)

响应：

![image-20231129202645370](https://raw.githubusercontent.com/charming-c/image-host/master/img/image-20231129202645370.png)

![image-20231129204702345](https://raw.githubusercontent.com/charming-c/image-host/master/img/image-20231129204702345.png)

#### 2. 大致的请求逻辑

- 在进入页面时，就会检查一次版本更新

![image-20231129210030282](https://raw.githubusercontent.com/charming-c/image-host/master/img/image-20231129210030282.png)

- 检查完以后就会获得对应的安装信息

    - 这里的 `OnCheckUpgrade` 应该是请求成功的回调

    ![image-20231129204126658](https://raw.githubusercontent.com/charming-c/image-host/master/img/image-20231129204126658.png)

    ![image-20231129204457037](https://raw.githubusercontent.com/charming-c/image-host/master/img/image-20231129204457037.png)

    ![image-20231129202947003](https://raw.githubusercontent.com/charming-c/image-host/master/img/image-20231129202947003.png)

- `CheckUpgradeLoader` 应该是一个网络请求的加载器，请求成功后会就回调回 OnCheckUpgrade 方法

- 之后就获得了请求的 apk 信息



![image-20231129203257365](https://raw.githubusercontent.com/charming-c/image-host/master/img/image-20231129203257365.png)

![image-20231129203758508](https://raw.githubusercontent.com/charming-c/image-host/master/img/image-20231129203758508.png)



写文件之后，安装 apk 就完成版本更新了。  











